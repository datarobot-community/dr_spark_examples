{"paragraphs":[{"text":"import org.apache.spark.sql.functions.{col}\nimport org.apache.spark.sql.{DataFrame, Dataset, SparkSession}\nimport org.apache.spark.sql.SaveMode\nimport java.time.LocalDateTime\nimport com.amazonaws.regions.Regions\nimport com.amazonaws.services.secretsmanager.AWSSecretsManagerClientBuilder\nimport com.amazonaws.services.secretsmanager.model.GetSecretValueRequest\nimport org.json4s.{DefaultFormats, MappingException}\nimport org.json4s.jackson.JsonMethods._\nimport com.datarobot.prediction.spark.Predictors.{getPredictorFromServer, getPredictor}\n","user":"anonymous","dateUpdated":"2020-06-07T10:13:23+0000","config":{"tableHide":true,"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"import org.apache.spark.sql.functions.col\nimport org.apache.spark.sql.{DataFrame, Dataset, SparkSession}\nimport org.apache.spark.sql.SaveMode\nimport java.time.LocalDateTime\nimport com.amazonaws.regions.Regions\nimport com.amazonaws.services.secretsmanager.AWSSecretsManagerClientBuilder\nimport com.amazonaws.services.secretsmanager.model.GetSecretValueRequest\nimport org.json4s.{DefaultFormats, MappingException}\nimport org.json4s.jackson.JsonMethods._\nimport com.datarobot.prediction.spark.Predictors.{getPredictorFromServer, getPredictor}\n"}]},"apps":[],"jobName":"paragraph_1591513502456_-44282975","id":"20200603-065838_1328964109","dateCreated":"2020-06-07T07:05:02+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1289","dateFinished":"2020-06-07T10:13:23+0000","dateStarted":"2020-06-07T10:13:23+0000"},{"text":"\tdef printMsg(msg: String): (Unit) = {\n\t\tprintln(LocalDateTime.now() + \" - \" + msg)\n\t}","user":"anonymous","dateUpdated":"2020-06-07T10:13:23+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"printMsg: (msg: String)Unit\n"}]},"apps":[],"jobName":"paragraph_1591513502460_-1406109292","id":"20200603-070252_1876237427","dateCreated":"2020-06-07T07:05:02+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1290","dateFinished":"2020-06-07T10:13:24+0000","dateStarted":"2020-06-07T10:13:23+0000"},{"text":"\t/* get secret string from secrets manager */\n\tdef getSecret(secretName: String): (String) = {\n\n\t\tval region = Regions.US_EAST_1\n\n\t\tval client = AWSSecretsManagerClientBuilder.standard()\n\t\t\t.withRegion(region)\n\t\t\t.build()\n\n\t\tval getSecretValueRequest = new GetSecretValueRequest()\n\t\t\t.withSecretId(secretName)\n\n\t\tval res = client.getSecretValue(getSecretValueRequest)\n\t\tval secret = res.getSecretString\n\n\t\treturn secret\n\t}\n","user":"anonymous","dateUpdated":"2020-06-07T10:13:24+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"getSecret: (secretName: String)String\n"}]},"apps":[],"jobName":"paragraph_1591513502460_694112838","id":"20200603-065847_765380812","dateCreated":"2020-06-07T07:05:02+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1291","dateFinished":"2020-06-07T10:13:24+0000","dateStarted":"2020-06-07T10:13:24+0000"},{"text":"\t/* get secret value from secrets string once provided key */\n\tdef getSecretKeyValue(jsonString: String, keyString: String): (String) = {\n\t    \n\t\timplicit val formats = DefaultFormats\n        val parsedJson = parse(jsonString)  \n\t\tval keyValue = (parsedJson \\ keyString).extract[String]\n\t\treturn keyValue\n\t}\n","user":"anonymous","dateUpdated":"2020-06-07T10:13:24+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"getSecretKeyValue: (jsonString: String, keyString: String)String\n"}]},"apps":[],"jobName":"paragraph_1591513502460_-1768794437","id":"20200603-065918_152661460","dateCreated":"2020-06-07T07:05:02+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1292","dateFinished":"2020-06-07T10:13:24+0000","dateStarted":"2020-06-07T10:13:24+0000"},{"text":"\t/* run sql and extract sql into spark dataframe */\n\tdef snowflakedf(defaultOptions: Map[String, String], sql: String) = {\n\t    \n\t\tval spark = SparkSession.builder.getOrCreate()\n\n\t\tspark.read\n\t\t.format(\"net.snowflake.spark.snowflake\")\n\t\t.options(defaultOptions)\n\t\t.option(\"query\", sql)\n\t\t.load()\n\t}\n","user":"anonymous","dateUpdated":"2020-06-07T10:13:24+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"snowflakedf: (defaultOptions: Map[String,String], sql: String)org.apache.spark.sql.DataFrame\n"}]},"apps":[],"jobName":"paragraph_1591513502461_-1641713113","id":"20200603-065927_860433687","dateCreated":"2020-06-07T07:05:02+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1293","dateFinished":"2020-06-07T10:13:25+0000","dateStarted":"2020-06-07T10:13:24+0000"},{"text":"\t\tval SECRET_NAME = \"snow/titanic\"\n\n\t\tprintMsg(\"db_log: \" + \"START\")\n\t\tprintMsg(\"db_log: \" + \"Creating SparkSession...\")\n\t\tval spark = SparkSession.builder.appName(\"SnowScore\").getOrCreate();\n\n\t\tprintMsg(\"db_log: \" + \"Obtaining secrets...\")\n\t\tval secret = getSecret(SECRET_NAME)\n\n\t\tprintMsg(\"db_log: \" + \"Parsing secrets...\")\n\t\tval dr_host = getSecretKeyValue(secret, \"dr_host\")\n\t\tval dr_project = getSecretKeyValue(secret, \"dr_project\")\n\t\tval dr_model = getSecretKeyValue(secret, \"dr_model\")\n\t\tval dr_token = getSecretKeyValue(secret, \"dr_token\")\n\t\tval db_host = getSecretKeyValue(secret, \"db_host\")\n\t\tval db_db = getSecretKeyValue(secret, \"db_db\")\n\t\tval db_schema = getSecretKeyValue(secret, \"db_schema\")\n\t\tval db_user = getSecretKeyValue(secret, \"db_user\")\n\t\tval db_pass = getSecretKeyValue(secret, \"db_pass\")\n\t\tval db_query_file = getSecretKeyValue(secret, \"db_query_file\")\n\t\tval output_type = getSecretKeyValue(secret, \"output_type\")\n\n\t\tprintMsg(\"db_log: \" + \"Retrieving db query...\")\n\t\tval df_query = spark.read.text(db_query_file)\n\t\tval query = df_query.select(col(\"value\")).first.getString(0)\n","user":"anonymous","dateUpdated":"2020-06-07T10:17:11+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1591513502461_-689465391","id":"20200603-065930_1379903817","dateCreated":"2020-06-07T07:05:02+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:1294","dateFinished":"2020-06-07T10:13:25+0000","dateStarted":"2020-06-07T10:13:25+0000"},{"text":"\t\tprintMsg(\"db_log: \" + \"Loading Model...\")\n\t\tval spark_compatible_model = getPredictorFromServer(host=dr_host, projectId=dr_project, modelId=dr_model, token=dr_token)\n","user":"anonymous","dateUpdated":"2020-06-07T10:13:25+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1591513502461_-108304216","id":"20200603-070012_319029074","dateCreated":"2020-06-07T07:05:02+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:1295","dateFinished":"2020-06-07T10:13:37+0000","dateStarted":"2020-06-07T10:13:25+0000"},{"user":"anonymous","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1591514684177_-422528574","id":"20200607-072444_127828964","dateCreated":"2020-06-07T07:24:44+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2250","text":"\t\tprintMsg(\"db_log: \" + \"Extracting data from database...\")\n\t\tval defaultOptions = Map(\n\t\t\t\"sfURL\" -> db_host,\n\t\t\t\"sfAccount\" -> db_host.split('.')(0),\n\t\t\t\"sfUser\" -> db_user,\n\t\t\t\"sfPassword\" -> db_pass,  \n\t\t\t\"sfDatabase\" -> db_db,\n\t\t\t\"sfSchema\" -> db_schema\n\t\t)\n\n\t\tval df = snowflakedf(defaultOptions, query)\n\t\t\n\t\tdf.show()\n","dateUpdated":"2020-06-07T10:13:37+0000","dateFinished":"2020-06-07T10:13:39+0000","dateStarted":"2020-06-07T10:13:37+0000","errorMessage":""},{"text":"\t\tprintMsg(\"db_log: \" + \"Scoring Model...\")\n\t\tval result_df = spark_compatible_model.transform(df)\n\n\t\tval subset_df = result_df.select(\"PASSENGERID\", \"target_1_PREDICTION\")\n\t\tsubset_df.cache()\n\n        subset_df.show()","user":"anonymous","dateUpdated":"2020-06-07T10:13:39+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"2020-06-07T10:13:40.236 - db_log: Scoring Model...\n+-----------+-------------------+\n|PASSENGERID|target_1_PREDICTION|\n+-----------+-------------------+\n|    2221088|0.13739321338332044|\n|    2221089|0.49463435083742285|\n|    2221090| 0.6794554984103072|\n|    2221091|0.48094513211225937|\n|    2221092| 0.3540517423946332|\n|    2221093| 0.9189122419149839|\n|    2221094|0.11702597508801961|\n|    2221095|0.17587599395060743|\n|    2221096|0.45220454654866454|\n|    2221097|0.11702597508801961|\n|    2221098| 0.9223385369209587|\n|    2221099|0.11249335654076126|\n|    2221100|0.13220186416519955|\n|    2221101|0.11249335654076126|\n|    2221102|0.17177293997455864|\n|    2221103| 0.9020334061874042|\n|    2221104|0.19634393311425044|\n|    2221105| 0.4716471889185727|\n|    2221106| 0.3588527289261099|\n|    2221107|0.21494097077857197|\n+-----------+-------------------+\nonly showing top 20 rows\n\nresult_df: org.apache.spark.sql.DataFrame = [PASSENGERID: decimal(38,0), PCLASS: decimal(38,0) ... 11 more fields]\nsubset_df: org.apache.spark.sql.DataFrame = [PASSENGERID: decimal(38,0), target_1_PREDICTION: double]\n"}]},"apps":[],"jobName":"paragraph_1591513502462_-1252696650","id":"20200603-070413_873101267","dateCreated":"2020-06-07T07:05:02+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1296","dateFinished":"2020-06-07T10:14:22+0000","dateStarted":"2020-06-07T10:13:40+0000"},{"text":"val output_type = \"table\"\n","user":"anonymous","dateUpdated":"2020-06-07T10:14:22+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"output_type: String = table\n"}]},"apps":[],"jobName":"paragraph_1591513502462_523591860","id":"20200605-144110_1878223359","dateCreated":"2020-06-07T07:05:02+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1297","dateFinished":"2020-06-07T10:14:22+0000","dateStarted":"2020-06-07T10:14:22+0000"},{"text":"\t\tif(output_type == \"s3\") {\n\t\t\tval s3_output_loc = getSecretKeyValue(secret, \"s3_output_loc\")\n\t\t\tprintMsg(\"db_log: \" + \"Writing to S3...\")\n\t\t\tsubset_df.write.format(\"csv\").option(\"header\",\"true\").mode(\"Overwrite\").save(s3_output_loc)\n\t\t}\n\t\telse if(output_type == \"table\") {\n\t\t\tval db_output_table = getSecretKeyValue(secret, \"db_output_table\")\n\t\t\tsubset_df.write\n                .format(\"net.snowflake.spark.snowflake\")\n                .options(defaultOptions)\n                .option(\"dbtable\", db_output_table)\n                .mode(SaveMode.Overwrite)\n                .save()\n\t\t}\n\t\telse {\n\t\t\tprintMsg(\"db_log: \" + \"Results not written to S3 or database; output_type value must be either 's3' or 'table'.\")\n\t\t}\n\n\t\tprintMsg(\"db_log: \" + \"Written record count - \" + subset_df.count())\n\t\tprintMsg(\"db_log: \" + \"FINISH\")\n","user":"anonymous","dateUpdated":"2020-06-07T10:14:22+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"2020-06-07T10:15:23.598 - db_log: Written record count - 3000000\n2020-06-07T10:15:23.599 - db_log: FINISH\n"}]},"apps":[],"jobName":"paragraph_1591513502462_20323503","id":"20200603-070445_294634888","dateCreated":"2020-06-07T07:05:02+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1298","dateFinished":"2020-06-07T10:15:23+0000","dateStarted":"2020-06-07T10:14:22+0000"}],"name":"snowflake_scala_note","id":"2F9YN54N2","noteParams":{},"noteForms":{},"angularObjects":{"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}